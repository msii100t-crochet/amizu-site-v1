<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç·¨ã¿å›³ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆã‹ãé‡ï¼‰</title>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --card:#f5f5f7; --line:#e6e6ea; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:20px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(255,255,255,.9); backdrop-filter: blur(6px); z-index:5; }
    header h1 { margin:0; font-size:18px; }
    header p { margin:6px 0 0; color:var(--muted); font-size:13px; }
    main { padding:18px 16px 40px; max-width: 980px; margin:0 auto; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 14px; font-size:14px; }
    button:active { transform: translateY(1px); }
    button.selected { border-color:#111; }
    .small { font-size:12px; color:var(--muted); }
    canvas {
  width:100%;
  height:auto;
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  touch-action: none;

  /* ğŸŒŸ ã”è¤’ç¾ã‚«ã‚¹ã‚¿ãƒ  */
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
}
    input[type="text"]{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; background:#fff; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px; color:var(--muted); }
    footer { padding:16px; color:var(--muted); font-size:12px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <h1>ç·¨ã¿å›³ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆã‹ãé‡ï¼‰</h1>
    <p>è¨˜å·ãƒ‘ãƒ¬ãƒƒãƒˆ â†’ é¸ã‚“ã è¨˜å·ã‚’ã‚¿ãƒƒãƒ—ã§ç½®ã‘ã¾ã™ï¼ˆç«¯æœ«å†…ã«ä¿å­˜ï¼‰</p>
  </header>

  <main class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <span class="badge" id="mode">é¸æŠä¸­ï¼šé–</span>
        <span class="small">â€»ã‚¹ãƒãƒ›ã¯ã‚¿ãƒƒãƒ—ã§OK</span>
      </div>

      <!-- ãƒ‘ãƒ¬ãƒƒãƒˆ -->
      <div class="row" style="margin-top:12px;">
        <button class="tool selected" data-type="ch">é–</button>
        <button class="tool" data-type="sc">ç´°ç·¨ã¿</button>
        <button class="tool" data-type="dc">é•·ç·¨ã¿</button>
        <button class="tool" data-type="erase">æ¶ˆã—ã‚´ãƒ </button>
      </div>

      <div style="margin-top:12px;">
        <canvas id="c" width="900" height="520"></canvas>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="undo">1ã¤æˆ»ã™</button>
        <button id="clear">å…¨éƒ¨æ¶ˆã™</button>
        <button id="savepng">PNGä¿å­˜</button>
      </div>

      <p class="small" style="margin:10px 0 0;">
        ä½¿ã„æ–¹ï¼šä¸Šã§è¨˜å·ã‚’é¸ã¶ â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§é…ç½®ã€‚æ¶ˆã—ã‚´ãƒ ã¯è¿‘ã„è¨˜å·ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
      </p>
    </section>

    <aside class="card">
      <h2 style="margin:0 0 10px; font-size:16px;">ã‚¿ã‚¤ãƒˆãƒ«</h2>
      <input id="title" type="text" placeholder="ä¾‹ï¼‰ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼ 1æ®µç›®" />
      <p class="small">ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0;" />

      <h2 style="margin:0 0 8px; font-size:16px;">æ¬¡ã«ä½œã‚‹æ©Ÿèƒ½ï¼ˆäºˆå®šï¼‰</h2>
      <ul class="small" style="line-height:1.7; margin:0; padding-left:18px;">
        <li>ã‚¹ãƒŠãƒƒãƒ—ï¼ˆæ ¼å­ã«å¸ç€ï¼‰</li>
        <li>æ®µç•ªå·ãƒ»æ³¨é‡ˆ</li>
        <li>æ—¥æœ¬å¼è¨˜å·ã®æç”»ã‚’ç²¾å¯†åŒ–</li>
        <li>å…¬é–‹ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆå¾Œã§ï¼‰</li>
      </ul>
    </aside>
  </main>

  <footer>Â© ç·¨ã¿å›³ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆè©¦ä½œï¼‰</footer>

  <script>
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");
    const titleEl = document.getElementById("title");
    const undoBtn = document.getElementById("undo");
    const clearBtn = document.getElementById("clear");
    const savePngBtn = document.getElementById("savepng");
    const modeEl = document.getElementById("mode");
    const toolBtns = Array.from(document.querySelectorAll(".tool"));

    // --- state ---
    const KEY = "amizu_items_v2";
    const KEY_TITLE = "amizu_title_v1";
    let items = []; // {x,y,type}
    let current = "ch"; // ch / sc / dc / erase

    const LABEL = { ch: "é–", sc: "ç´°ç·¨ã¿", dc: "é•·ç·¨ã¿", erase: "æ¶ˆã—ã‚´ãƒ " };
    const GRID = 30;      // ã‚°ãƒªãƒƒãƒ‰é–“éš”ï¼ˆä»Šã®ç·šã¨åŒã˜ï¼‰
    const SNAP = true;    // ã‚¹ãƒŠãƒƒãƒ—ON/OFFï¼ˆå¾Œã§ãƒˆã‚°ãƒ«åŒ–ã§ãã‚‹ï¼‰
    let scale = 1;

    let isDrawing = false;
    let lastPlaced = null;
    
ã€€ã€€ã€€let isDrawing = false;
ã€€ã€€ã€€let lastPlaced = null; // {x,y}
    
    function load() {
      try { items = JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { items = []; }
      titleEl.value = localStorage.getItem(KEY_TITLE) || "";
    }

    function persist() {
      localStorage.setItem(KEY, JSON.stringify(items));
      localStorage.setItem(KEY_TITLE, titleEl.value || "");
    }

    function setTool(type) {
      current = type;
      modeEl.textContent = "é¸æŠä¸­ï¼š" + LABEL[type];
      toolBtns.forEach(b => b.classList.toggle("selected", b.dataset.type === type));
    }

    function drawGrid() {
      ctx.save();
      ctx.globalAlpha = 0.14;
      ctx.strokeStyle = "#000";
      for (let x=0; x<=canvas.width; x+=30) {
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
      }
      for (let y=0; y<=canvas.height; y+=30) {
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
      }
      ctx.restore();
    }

    function drawTitle() {
      ctx.fillStyle = "#111";
      ctx.font = "22px sans-serif";
      ctx.fillText(titleEl.value || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰", 18, 36);
    }

    // --- è¨˜å·ã®ç°¡æ˜“æç”»ï¼ˆå¾Œã§æ—¥æœ¬å¼ã«å¯„ã›ã‚‰ã‚Œã‚‹ï¼‰ ---
    function drawSymbol(type, x, y) {
      ctx.save();
      ctx.strokeStyle = "#111";
      ctx.fillStyle = "#111";
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";

      if (type === "ch") {
        // é–ï¼šå°ã•ãªæ¥•å††ï¼ˆè¼ªï¼‰
        ctx.beginPath();
        ctx.ellipse(x, y, 10, 7, 0, 0, Math.PI * 2);
        ctx.stroke();
      } else if (type === "sc") {
        // ç´°ç·¨ã¿ï¼šÃ—
        ctx.beginPath();
        ctx.moveTo(x-8, y-8); ctx.lineTo(x+8, y+8);
        ctx.moveTo(x+8, y-8); ctx.lineTo(x-8, y+8);
        ctx.stroke();
      } else if (type === "dc") {
        // é•·ç·¨ã¿ï¼šTã£ã½ã„å½¢
        ctx.beginPath();
        ctx.moveTo(x, y-12); ctx.lineTo(x, y+12);
        ctx.moveTo(x-10, y-2); ctx.lineTo(x+10, y-2);
        ctx.stroke();
      }
      ctx.restore();
    }

    function redraw() {
  const s = (typeof scale === "number" && isFinite(scale)) ? scale : 1;

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.scale(s, s);

  drawGrid();
  drawTitle();
  for (const it of items) drawSymbol(it.type, it.x, it.y);

  ctx.restore();
}


    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
      const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
      const x = (clientX - rect.left) * (canvas.width / rect.width);
      const y = (clientY - rect.top) * (canvas.height / rect.height);
      return { x: x / scale, y: y / scale };
    }

    function dist2(a, b) {
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  return dx*dx + dy*dy;
}

// ğŸ‘‡ ã“ã“ã«å…¥ã‚Œã‚‹ï¼
function touchDist(t1, t2) {
  const dx = t1.clientX - t2.clientX;
  const dy = t1.clientY - t2.clientY;
  return Math.hypot(dx, dy);
}

function findNearestIndex(p, maxPx=22) {
  if (items.length === 0) return -1;
  const max2 = maxPx*maxPx;
  let best = -1, bestD = Infinity;
  for (let i=0;i<items.length;i++){
    const d = dist2(p, items[i]);
    if (d < bestD) { bestD = d; best = i; }
  }
  return bestD <= max2 ? best : -1;
}

    function snapPoint(p) {
  if (SNAP) {
    p.x = Math.round(p.x / GRID) * GRID;
    p.y = Math.round(p.y / GRID) * GRID;
  }
  return p;
}

function maybePlace(p) {
  p = snapPoint(p);

  // æ¶ˆã—ã‚´ãƒ ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã§OK
  if (current === "erase") {
    const idx = findNearestIndex(p);
    if (idx !== -1) {
      items.splice(idx, 1);
      persist(); redraw();
    }
    lastPlaced = p;
    return;
  }

  // åŒã˜ãƒã‚¹ã«é€£ç¶šã§ç½®ã‹ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  if (lastPlaced && lastPlaced.x === p.x && lastPlaced.y === p.y) return;

  items.push({ x: p.x, y: p.y, type: current });
  persist(); redraw();
  lastPlaced = p;
}

  

    function startDraw(evt) {

      if (evt.touches && evt.touches.length === 2) return;
  evt.preventDefault();
  isDrawing = true;
  lastPlaced = null;
  const p = getPos(evt);
  maybePlace(p);
}

function moveDraw(evt) {
  // â˜… 2æœ¬æŒ‡ã®ã¨ãã¯æç”»ã—ãªã„ï¼ˆãƒ”ãƒ³ãƒç”¨ï¼‰
  if (evt.touches && evt.touches.length === 2) return;
  if (!isDrawing) return;

  evt.preventDefault();
  const p = getPos(evt);
  maybePlace(p);
}

function endDraw(evt) {
  if (!isDrawing) return;
  evt.preventDefault();
  isDrawing = false;
  lastPlaced = null;
}

// mouse
canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
window.addEventListener("mouseup", endDraw);

// touch
canvas.addEventListener("touchstart", startDraw, { passive: false });
canvas.addEventListener("touchmove", moveDraw, { passive: false });
window.addEventListener("touchend", endDraw, { passive: false });

    titleEl.addEventListener("input", () => { persist(); redraw(); });

    toolBtns.forEach(btn => {
      btn.addEventListener("click", () => setTool(btn.dataset.type));
    });

    undoBtn.addEventListener("click", () => {
      items.pop();
      persist(); redraw();
    });

    clearBtn.addEventListener("click", () => {
      if (!confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
      items = [];
      persist(); redraw();
    });

    savePngBtn.addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = (titleEl.value || "amizu") + ".png";
      a.click();
    });

    load();
    setTool("ch");
    redraw();
  </script>
</body>
</html>
